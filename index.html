<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival Planner</title>
<style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #f1c40f;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #1a2a3a;
            --success-color: #27ae60;
            --info-color: #3498db;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            font-size: 16px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        nav {
            background-color: var(--dark-color);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        nav ul {
            display: flex;
            list-style: none;
            justify-content: flex-start;
            flex-wrap: nowrap;
            padding: 5px;
            white-space: nowrap;
        }
        nav ul li {
            padding: 10px 15px;
            position: relative;
            flex-shrink: 0;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        nav ul li a i {
            margin-right: 5px;
            font-size: 1rem;
        }
        nav ul li a:hover {
            color: var(--secondary-color);
        }
        nav ul li.active a {
            color: var(--secondary-color);
        }
        nav ul li.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--secondary-color);
            border-radius: 3px 3px 0 0;
        }
        .calculator-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .calculator-section.active {
            display: block;
        }
        h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--secondary-color);
            font-size: 1.3rem;
        }
        .calculator-grid {
            display: block;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }
        select, input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.2);
        }
        button {
            background-color: var(--secondary-color);
            color: var(--dark-color);
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
        }
        button i {
            margin-right: 5px;
        }
        button:hover {
            background-color: #f39c12;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(0);
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f8f5;
            border-radius: 8px;
            display: none;
            border-left: 4px solid var(--success-color);
        }
        .result h3 {
            color: var(--success-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }
        .result h3 i {
            margin-right: 8px;
        }
        .result p {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .result span {
            font-weight: 600;
            color: var(--dark-color);
        }
        .requirements-table {
            margin-top: 20px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .requirements-table h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }
        .requirements-table h3 i {
            margin-right: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            min-width: 600px;
            font-size: 0.85rem;
        }
        th, td {
            padding: 8px 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #eaeaea;
        }
        .note {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }
        .coming-soon {
            text-align: center;
            padding: 20px 10px;
        }
        .coming-soon i {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        .coming-soon h3 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 180px;
            background-color: var(--dark-color);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .gear-block {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        select:disabled {
            background-color: #eee;
            color: #888;
            cursor: not-allowed;
        }
        #upgrade-steps table {
            margin-top: 10px;
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        #upgrade-steps th, #upgrade-steps td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        #upgrade-steps th {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.9rem;
        }
        .gear-level-selector {
            display: block;
        }
        .gear-preview {
            text-align: center;
            margin-top: 10px;
        }
        .gear-preview img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 10px;
        }
        .gear-header {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
            padding-left: 10px !important;
            font-size: 0.95rem;
        }
        #calculate-all-gears:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        #upgrade-steps-gears td {
            text-align: center;
            font-size: 0.85rem;
        }
        #upgrade-steps-gears td:empty:before {
            content: '-';
            color: #999;
        }
        #upgrade-steps-gears {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        #upgrade-steps-gears th, 
        #upgrade-steps-gears td {
            padding: 8px 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        #upgrade-steps-gears th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        #upgrade-steps-gears .gear-header {
            background-color: var(--dark-color);
            text-align: left;
            padding-left: 10px;
        }
        #upgrade-steps-gears tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        /* --- CHIEF CHARMS STYLES --- */
        .charm-row {
            display: block;
            margin-bottom: 15px;
        }
        .charm-set {
            margin-bottom: 10px;
            background-color: #f8f8f8;
            padding: 12px;
            border-radius: 6px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        #charms-result table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        #charms-result th,
        #charms-result td {
            padding: 8px 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        #charms-result th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        #charms-result tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .tutorial-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }
        .tutorial-section h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 1rem;
        }
        .tutorial-section h4:before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: var(--secondary-color);
            margin-right: 8px;
        }
        .tutorial-section ol, .tutorial-section ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }
        .tutorial-section li {
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        /* Responsive adjustments */
        @media (min-width: 768px) {
            .container {
                padding: 20px;
            }
            header {
                padding: 20px 0;
            }
            header h1 {
                font-size: 2rem;
            }
            nav ul {
                justify-content: center;
            }
            .calculator-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
            .charm-row {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
            }
            .charm-set {
                flex: 1;
                min-width: 200px;
            }
            .gear-level-selector {
                display: grid;
                grid-template-columns: 1fr 1fr 80px;
                gap: 10px;
            }
        }
        .map-planner-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .map-planner-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
        }
        .map-planner-header h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .map-planner-header p {
            color: #666;
            font-size: 0.9rem;
        }
        .map-planner-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        @media (min-width: 992px) {
            .map-planner-content {
                flex-direction: row;
            }
        }
        .map-planner-grid-container {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .map-planner-toolbar {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        @media (max-width: 768px) {
            .map-planner-toolbar {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .map-planner-toolbar-btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            color: var(--dark-color);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
            height: 60px;
            text-align: center;
            width: 100%;
        }
        @media (max-width: 768px) {
            .map-planner-toolbar-btn {
                min-width: 0;
            }
        }
        .map-planner-toolbar-btn i {
            font-size: 1rem;
        }
        .map-planner-toolbar-btn:hover {
            background: linear-gradient(to bottom, #e9ecef, #dee2e6);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .map-planner-toolbar-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .map-planner-toolbar-btn.active {
            background: linear-gradient(to right, var(--secondary-color), #f39c12);
            color: white;
            box-shadow: 0 0 0 2px rgba(241, 196, 15, 0.3);
        }
        .map-planner-toolbar-btn.primary {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        .map-planner-toolbar-btn.danger {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
        }
        .map-planner-toolbar-btn.success {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }
        .map-planner-toolbar-btn.secondary {
            background: linear-gradient(to right, #7f8c8d, #95a5a6);
            color: white;
        }
        .map-planner-grid-wrapper {
            position: relative;
            overflow: auto;
            border: 2px solid #34495e;
            border-radius: 8px;
            background-color: #2c3e50;
            height: 400px;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        .map-planner-zoom-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .map-planner-zoom-btn {
            padding: 10px 16px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border: 1px solid #ddd;
            color: var(--dark-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .map-planner-zoom-btn:hover {
            background: linear-gradient(to bottom, #e9ecef, #dee2e6);
        }
        .map-planner-zoom-btn i {
            font-size: 0.9rem;
        }
        .map-planner-grid-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 15px;
        }
        .map-planner-grid-info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .map-planner-grid-info-label {
            color: #7f8c8d;
            font-weight: normal;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }
        .map-planner-grid-info-value {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1rem;
        }
        .map-planner-layout-controls {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .map-planner-layout-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .map-planner-selection-info {
            padding: 15px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            border: 1px solid #eee;
            min-height: 120px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        .map-planner-notice {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            border-left: 4px solid #ffeeba;
            margin-top: 15px;
        }
        .map-planner-controls {
            width: 100%;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 0 0 320px;
        }
        @media (min-width: 992px) {
            .map-planner-controls {
                width: 320px;
            }
        }
        .map-planner-grid {
            display: grid;
            background-color: #2c3e50;
            position: relative;
            transform-origin: 0 0;
            transition: transform 0.2s ease;
            --cell-size: 25px;
            margin: 0;
            padding: 0;
        }
        .map-planner-control-group {
            margin-bottom: 15px;
            background: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .map-planner-control-group h3 {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .map-planner-control-group h3 i {
            color: var(--secondary-color);
        }
        .map-planner-form-group {
            margin-bottom: 12px;
        }
        .map-planner-form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        .map-planner-form-group input[type="number"],
        .map-planner-form-group input[type="text"],
        .map-planner-form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .map-planner-form-group input[type="number"]:focus,
        .map-planner-form-group input[type="text"]:focus,
        .map-planner-form-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.2);
        }
        .map-planner-color-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .map-planner-color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .map-planner-color-option.selected {
            border-color: var(--dark-color);
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .map-planner-color-option.selected i {
            display: block;
        }
        .map-planner-color-option i {
            display: none;
            font-size: 0.8rem;
        }
        .map-planner-custom-color-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .map-planner-custom-color-label {
            white-space: nowrap;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .map-planner-custom-color-input {
            width: 60px;
            height: 28px;
            padding: 0;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
        }
        .map-planner-multi-select-info {
            margin-top: 8px;
            padding: 8px;
            background-color: #fff8e1;
            border-left: 3px solid var(--secondary-color);
            border-radius: 4px;
            color: var(--dark-color);
            font-size: 0.85rem;
        }
        .map-planner-stats-panel {
            margin-top: 12px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            border: 1px solid #eee;
            font-size: 0.9rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .map-planner-stats-panel p {
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        .map-planner-stats-panel .label {
            color: #7f8c8d;
            font-weight: normal;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }
        .map-planner-stats-panel span {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1rem;
        }
        .map-planner-grid-cell {
            background-color: #34495e;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            margin: 0;
            padding: 0;
            transition: background-color 0.2s;
        }
        .map-planner-grid-cell.occupied {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .map-planner-grid-object {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            user-select: none;
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 2;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.3), 
                        0 0 0 2px rgba(255,255,255,0.1),
                        inset 0 0 10px rgba(0,0,0,0.2);
            margin: 0;
            padding: 0;
            font-size: 0.8rem;
            transition: all 0.2s;
            cursor: move;
        }
        .map-planner-grid-object.placing {
            pointer-events: none;
            opacity: 0.7;
            z-index: 1;
        }
        .map-planner-grid-object.selected {
            border: 2px solid var(--secondary-color);
            z-index: 3;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.5), 
                        0 0 0 2px rgba(255,255,255,0.2),
                        inset 0 0 15px rgba(0,0,0,0.3);
        }
        .map-planner-grid-object.dragging {
            opacity: 0.9;
            z-index: 4;
            transition: none;
        }
        .map-planner-grid-object.dragging.valid {
            border-color: #27ae60;
        }
        .map-planner-grid-object.dragging.invalid {
            border-color: #e74c3c;
        }
        .map-planner-object-blue { background: #3498db; }
        .map-planner-object-red { background: #e74c3c; }
        .map-planner-object-green { background: #2ecc71; }
        .map-planner-object-purple { background: #9b59b6; }
        .map-planner-object-orange { background: #e67e22; }
        .map-planner-object-custom { background: #3498db; }

        /* Status message styles */
        .map-planner-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .map-planner-status.show {
            opacity: 1;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Whiteout Survival Planner</h1>
            <p>Plan and calculate upgrades needed for your hero and base upgrades</p>
        </header>
        <nav>
            <ul>
                <li class="active"><a href="#" data-section="introduction"><i class="fas fa-info"></i> Introduction</a></li>
                <li><a href="#" data-section="hero-shards"><i class="fas fa-star"></i> Hero Shards</a></li>
                <li><a href="#" data-section="chief-gears"><i class="fas fa-cogs"></i> Chief Gears</a></li>
                <li><a href="#" data-section="chief-charms"><i class="fas fa-gem"></i> Chief Charms</a></li>
                <li><a href="#" data-section="map-planner"><i class="fas fa-map"></i> Map Planner</a></li>
            </ul>
        </nav>
        <section id="introduction" class="calculator-section active">
    <h2><i class="fas fa-info-circle"></i> Welcome to Whiteout Survival Planner</h2>
    
    <div class="calculator-grid">
        <div>
            <h3 style="color: var(--secondary-color); margin-bottom: 15px;">About This Tool</h3>
            <p>This planner helps you optimize your Whiteout Survival gameplay with four powerful calculators:</p>
            <ol style="margin-left: 20px; margin-bottom: 20px;">
                <li><strong>Hero Shards Calculator</strong> - Plan your hero upgrades</li>
                <li><strong>Chief Gears Calculator</strong> - Track gear upgrade costs</li>
                <li><strong>Chief Charms Calculator</strong> - Manage charm resources</li>
                <li><strong>Map Planner</strong> - Design your base layout</li>
            </ol>
            
            <div class="gear-block" style="background-color: #e8f4f8;">
                <p>Use the navigation bar above to switch between tools. All calculations are performed in real-time!</p>
            </div>
        </div>
        
        <div>
    <h3 style="color: var(--secondary-color); margin-bottom: 15px;">Mobile Users: Use Desktop View</h3>
    <p><strong>Purpose:</strong> Some tools (like the Map Planner) require mouse and keyboard inputs which may not work well on mobile browsers.</p>
    <p><strong>How to use:</strong></p>
    <ol style="margin-left: 20px; margin-bottom: 20px;">
        <li>Tap the <strong>browser menu</strong> (usually three dots in the top/right corner)</li>
        <li>Select <strong>"Request desktop site"</strong> or <strong>"Desktop version"</strong></li>
        <li>Reload the page to load the full desktop version of this planner</li>
    </ol>
    <div class="gear-block" style="background-color: #e8f4f8;">
    <p>
    For best experience, use this planner on desktop or enable "Desktop Site" on mobile.
    </p>
    </div>

</div>
    </div>
    
    
    <div class="requirements-table">
        <h3><i class="fas fa-graduation-cap"></i>Tutorials</h3>
        
        <div class="tutorial-section">
            <h4>1. Hero Shards Calculator</h4>
            <p><strong>Purpose:</strong> Calculate exactly how many shards you need to upgrade your heroes.</p>
            <p><strong>How to use:</strong></p>
            <ol>
                <li>Select your hero's current star level and tier</li>
                <li>Choose your target star level and tier</li>
                <li>(Optional) Enter how many shards you already have</li>
                <li>Click "Calculate Required Shards"</li>
            </ol>
            <p>The results will show total shards needed and a detailed breakdown of requirements for each star level.</p>
        </div>
        
        <div class="tutorial-section">
            <h4>2. Chief Gears Calculator</h4>
            <p><strong>Purpose:</strong> Plan resource requirements for upgrading all 6 chief gears.</p>
            <p><strong>How to use:</strong></p>
            <ol>
                <li>For each gear, select current and target levels</li>
                <li>(Optional) Enter your current resources</li>
                <li>Click "Calculate Total Resource Requirements"</li>
            </ol>
            <p>View total materials needed and a step-by-step upgrade path for each gear.</p>
        </div>
        
        <div class="tutorial-section">
            <h4>3. Chief Charms Calculator</h4>
            <p><strong>Purpose:</strong> Track charm upgrades across all gear pieces.</p>
            <p><strong>How to use:</strong></p>
            <ol>
                <li>For each charm slot (3 per gear), set current and target levels</li>
                <li>Click "Calculate Resource Requirements"</li>
            </ol>
            <p>Get totals for Charm Guides, Designs, and Jewel Secrets needed for your upgrades.</p>
        </div>
        
        <div class="tutorial-section">
            <h4>4. Map Planner</h4>
            <p><strong>Purpose:</strong> Design and optimize your base layout before building in-game.</p>
            <p><strong>How to use:</strong></p>
            <ol>
                <li><strong>Place Objects:</strong> Click to add buildings of any size</li>
                <li><strong>Customize:</strong> Adjust width/height, colors, and labels</li>
                <li><strong>Edit:</strong> Select objects to move/delete them</li>
                <li><strong>Multi-select:</strong> Hold Shift to select multiple objects</li>
                <li><strong>Download:</strong> Save your layout as an image</li>
            </ol>
            <p>Key Features:</p>
            <ul>
                <li>Zoom in/out to see details</li>
                <li>Real-time utilization statistics</li>
                <li>Color-coding for different building types</li>
                <li>Custom grid sizes (up to 1000x1000)</li>
                <li>Save/Load multiple layouts</li>
                <li>Drag & Drop placement with collision detection</li>
            </ul>
        </div>
    </div>
    
    <div class="note" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
        <h4 style="color: var(--primary-color); margin-bottom: 10px;">Need Help?</h4>
        <p>Hover over <i class="fas fa-question-circle" style="color: var(--accent-color);"></i> icons for tooltips. For mobile users, note that multi-selection requires holding Shift (may not work on touch devices).</p>
        <p style="margin-top: 10px; font-weight: bold;">Bookmark this page to save your plans!</p>
    </div>
    <div class="note" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
    <h4 style="color: var(--primary-color); margin-bottom: 10px;">Contact</h4>
    <div style="display: flex; gap: 20px; align-items: center;">
        <div>
            <i class="fas fa-envelope"></i> Email: thepenguinfluffy@gmail.com
        </div>
    </div>
</div>
</section>

        <!-- Hero Shards Calculator -->
        <section id="hero-shards" class="calculator-section">
            <h2><i class="fas fa-star"></i> Hero Shards Calculator</h2>
            <div class="calculator-grid">
                <div>
                    <div class="form-group">
                        <label for="current-star">Current Star Level</label>
                        <select id="current-star">
                            <option value="0">0 Stars</option>
                            <option value="1">1 Star</option>
                            <option value="2">2 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="5">5 Stars (Max)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="current-tier">Current Tier</label>
                        <select id="current-tier">
                            <option value="0">Tier 0</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="target-star">Target Star Level</label>
                        <select id="target-star">
                            <option value="0">0 Stars</option>
                            <option value="1">1 Star</option>
                            <option value="2">2 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="5" selected>5 Stars (Max)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="target-tier">Target Tier</label>
                        <select id="target-tier">
                            <option value="0">Tier 0</option>
                            <option value="1">Tier 1</option>
                            <option value="2">Tier 2</option>
                            <option value="3">Tier 3</option>
                            <option value="4">Tier 4</option>
                            <option value="5">Tier 5</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="current-shards">
                    Current Shards Owned (optional)
                    <span class="tooltip">
                        <i class="fas fa-question-circle"></i>
                        <span class="tooltiptext">Enter the number of shards you currently have to calculate how many more you need</span>
                    </span>
                </label>
                <input type="number" id="current-shards" min="0" value="0" placeholder="Enter shards you already have">
            </div>
            <button id="calculate-shards">
                <i class="fas fa-calculator"></i> Calculate Required Shards
            </button>
            <div id="shards-result" class="result">
                <h3><i class="fas fa-clipboard-check"></i> Calculation Results</h3>
                <p>Total Shards Required: <span id="total-shards">0</span></p>
                <p>After Deducting Owned Shards: <span id="final-shards">0</span></p>
            </div>
            <!-- Add this inside the hero-shards section, right after the existing result div -->
<!-- Replace the existing upgrade-steps div with this -->
<div id="upgrade-steps" class="result" style="display: none;">
    <h3><i class="fas fa-list-ol"></i> Upgrade Steps Breakdown</h3>
    <table id="steps-table">
        <thead>
            <tr>
                <th>From → To</th>
                <th>Tier 1</th>
                <th>Tier 2</th>
                <th>Tier 3</th>
                <th>Tier 4</th>
                <th>Tier 5</th>
                <th>Promote</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="steps-body">
            <!-- Will be populated by JavaScript -->
        </tbody>
    </table>
</div>
            <div class="requirements-table">
    <h3><i class="fas fa-table"></i> Shard Requirements per Star Level</h3>
    <table>
        <thead>
            <tr>
                <th>Star Transition</th>
                <th>Tier 1</th>
                <th>Tier 2</th>
                <th>Tier 3</th>
                <th>Tier 4</th>
                <th>Tier 5</th>
                <th>Tier 6</th>
                <th>Total per Star</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>0 → 1st Star</td>
                <td>1</td>
                <td>1</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
                <td>10</td>
            </tr>
            <tr>
                <td>1st → 2nd Star</td>
                <td>5</td>
                <td>5</td>
                <td>5</td>
                <td>5</td>
                <td>5</td>
                <td>15</td>
                <td>40</td>
            </tr>
            <tr>
                <td>2nd → 3rd Star</td>
                <td>15</td>
                <td>15</td>
                <td>15</td>
                <td>15</td>
                <td>15</td>
                <td>40</td>
                <td>115</td>
            </tr>
            <tr>
                <td>3rd → 4th Star</td>
                <td>40</td>
                <td>40</td>
                <td>40</td>
                <td>40</td>
                <td>40</td>
                <td>100</td>
                <td>300</td>
            </tr>
            <tr>
                <td>4th → 5th Star</td>
                <td>100</td>
                <td>100</td>
                <td>100</td>
                <td>100</td>
                <td>100</td>
                <td>100</td>
                <td>600</td>
            </tr>
        </tbody>
    </table>
    <p class="note" style="color: green; font-weight: bold;">Note: Each star has 6 tiers. Completing all 6 tiers advances the hero to the next star level. 5 stars is the maximum level.</p>
    <p class="note" style="color: red; font-weight: bold;">Heroes need some shards to unlock as well and it varies to different heroes. (Example: Jessie needs 40 shards to unlock so her total shards required to max her out will be 1065+40=1105 whereas Jasser requires only 10 shards to unlock so total shards required for him will be 1065+10=1075)</p>
</div>
        </section>

        <!-- Chief Gears Calculator -->
<section id="chief-gears" class="calculator-section">
    <h2><i class="fas fa-cogs"></i> Chief Gears Calculator</h2>

     <p>Select current and target levels for each of the 6 gears below:</p>
    <div id="gears-container"></div>

    <!-- Current Resource Inputs -->
    <div class="form-group">
    <label for="owned-alloy">
        Current Hardened Alloy Owned (optional)
        <span class="tooltip">
            <i class="fas fa-question-circle"></i>
            <span class="tooltiptext">Enter the amount of Hardened Alloy you currently have to calculate how much more you need</span>
        </span>
    </label>
    <input type="number" id="owned-alloy" min="0" value="0" placeholder="Enter current alloy">
</div>
<div class="form-group">
    <label for="owned-solution">
        Current Polishing Solution Owned (optional)
        <span class="tooltip">
            <i class="fas fa-question-circle"></i>
            <span class="tooltiptext">Enter the amount of Polishing Solution you currently have to calculate how much more you need</span>
        </span>
    </label>
    <input type="number" id="owned-solution" min="0" value="0" placeholder="Enter current polishing solution">
</div>
<div class="form-group">
    <label for="owned-design">
        Current Design Plans Owned (optional)
        <span class="tooltip">
            <i class="fas fa-question-circle"></i>
            <span class="tooltiptext">Enter the amount of Design Plans you currently have to calculate how much more you need</span>
        </span>
    </label>
    <input type="number" id="owned-design" min="0" value="0" placeholder="Enter current design plans">
</div>
<div class="form-group">
    <label for="owned-amber">
        Current Lunar Amber Owned (optional)
        <span class="tooltip">
            <i class="fas fa-question-circle"></i>
            <span class="tooltiptext">Enter the amount of Lunar Amber you currently have to calculate how much more you need</span>
        </span>
    </label>
    <input type="number" id="owned-amber" min="0" value="0" placeholder="Enter current lunar amber">
</div>

   

    <button id="calculate-all-gears">
        <i class="fas fa-calculator"></i> Calculate Total Resource Requirements
    </button>

    <!-- Result Summary -->
    <div id="gear-result" class="result">
        <h3><i class="fas fa-clipboard-check"></i> Total Resource Requirements</h3>
        <p>Total Hardened Alloy: <span id="alloy-needed">0</span></p>
        <p>Total Polishing Solution: <span id="solution-needed">0</span></p>
        <p>Total Design Plans: <span id="design-needed">0</span></p>
        <p>Total Lunar Amber: <span id="amber-needed">0</span></p>
        <hr />
        <p>After Deducting Owned Resources:</p>
        <p>Hardened Alloy Needed: <span id="final-alloy">0</span></p>
        <p>Polishing Solution Needed: <span id="final-solution">0</span></p>
        <p>Design Plans Needed: <span id="final-design">0</span></p>
        <p>Lunar Amber Needed: <span id="final-amber">0</span></p>
    </div>

   <!-- Upgrade Steps Table -->
<div id="upgrade-steps-gears" class="requirements-table" style="display: none;">
    <h3><i class="fas fa-list-ol"></i> Gear Upgrade Breakdown</h3>
    <table>
        <thead>
            <tr>
                <th>Gear Name</th>
                <th>From Level</th>
                <th>To Level</th>
                <th>Hardened Alloy</th>
                <th>Polishing Solution</th>
                <th>Design Plans</th>
                <th>Lunar Amber</th>
            </tr>
        </thead>
        <tbody id="steps-body-gears"></tbody>
    </table>
</div>
<div class="requirements-table">
    <h3><i class="fas fa-table"></i> Gear Upgrade Resource Requirements</h3>
    <table>
        <thead>
            <tr>
                <th>Gear Level</th>
                <th>Hardened Alloy</th>
                <th>Polishing Solution</th>
                <th>Design Plans</th>
                <th>Lunar Amber</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Green Lvl 0</td><td>1,500</td><td>15</td><td>0</td><td>0</td></tr>
            <tr><td>Green Lvl 1</td><td>3,800</td><td>40</td><td>0</td><td>0</td></tr>
            <tr><td>Blue Lvl 0</td><td>7,000</td><td>70</td><td>0</td><td>0</td></tr>
            <tr><td>Blue Lvl 1</td><td>9,700</td><td>95</td><td>0</td><td>0</td></tr>
            <tr><td>Blue Lvl 2</td><td>0</td><td>0</td><td>45</td><td>0</td></tr>
            <tr><td>Blue Lvl 3</td><td>0</td><td>0</td><td>50</td><td>0</td></tr>
            <tr><td>Purple Lvl 0</td><td>0</td><td>0</td><td>60</td><td>0</td></tr>
            <tr><td>Purple Lvl 1</td><td>0</td><td>0</td><td>70</td><td>0</td></tr>
            <tr><td>Purple Lvl 2</td><td>6,500</td><td>65</td><td>40</td><td>0</td></tr>
            <tr><td>Purple Lvl 3</td><td>8,000</td><td>80</td><td>50</td><td>0</td></tr>
            <tr><td>Purple T1 Lvl 0</td><td>10,000</td><td>95</td><td>60</td><td>0</td></tr>
            <tr><td>Purple T1 Lvl 1</td><td>11,000</td><td>110</td><td>70</td><td>0</td></tr>
            <tr><td>Purple T1 Lvl 2</td><td>13,000</td><td>130</td><td>85</td><td>0</td></tr>
            <tr><td>Purple T1 Lvl 3</td><td>15,000</td><td>160</td><td>100</td><td>0</td></tr>
            <tr><td>Gold Lvl 0</td><td>22,000</td><td>220</td><td>40</td><td>0</td></tr>
            <tr><td>Gold Lvl 1</td><td>23,000</td><td>230</td><td>40</td><td>0</td></tr>
            <tr><td>Gold Lvl 2</td><td>25,000</td><td>250</td><td>45</td><td>0</td></tr>
            <tr><td>Gold Lvl 3</td><td>26,000</td><td>260</td><td>45</td><td>0</td></tr>
            <tr><td>Gold T1 Lvl 0</td><td>28,000</td><td>280</td><td>45</td><td>0</td></tr>
            <tr><td>Gold T1 Lvl 1</td><td>30,000</td><td>300</td><td>55</td><td>0</td></tr>
            <tr><td>Gold T1 Lvl 2</td><td>32,000</td><td>320</td><td>55</td><td>0</td></tr>
            <tr><td>Gold T1 Lvl 3</td><td>35,000</td><td>340</td><td>55</td><td>0</td></tr>
            <tr><td>Gold T2 Lvl 0</td><td>38,000</td><td>390</td><td>55</td><td>0</td></tr>
            <tr><td>Gold T2 Lvl 1</td><td>43,000</td><td>430</td><td>75</td><td>0</td></tr>
            <tr><td>Gold T2 Lvl 2</td><td>45,000</td><td>460</td><td>80</td><td>0</td></tr>
            <tr><td>Gold T2 Lvl 3</td><td>48,000</td><td>500</td><td>85</td><td>0</td></tr>
            <tr><td>Pink Lvl 0</td><td>50,000</td><td>530</td><td>85</td><td>10</td></tr>
            <tr><td>Pink Lvl 1</td><td>52,000</td><td>560</td><td>90</td><td>10</td></tr>
            <tr><td>Pink Lvl 2</td><td>54,000</td><td>590</td><td>95</td><td>10</td></tr>
            <tr><td>Pink Lvl 3</td><td>56,000</td><td>620</td><td>100</td><td>10</td></tr>
            <tr><td>Pink T1 Lvl 0</td><td>59,000</td><td>670</td><td>110</td><td>15</td></tr>
            <tr><td>Pink T1 Lvl 1</td><td>61,000</td><td>700</td><td>115</td><td>15</td></tr>
            <tr><td>Pink T1 Lvl 2</td><td>63,000</td><td>730</td><td>120</td><td>15</td></tr>
            <tr><td>Pink T1 Lvl 3</td><td>65,000</td><td>760</td><td>125</td><td>15</td></tr>
            <tr><td>Pink T2 Lvl 0</td><td>68,000</td><td>810</td><td>135</td><td>20</td></tr>
            <tr><td>Pink T2 Lvl 1</td><td>70,000</td><td>840</td><td>140</td><td>20</td></tr>
            <tr><td>Pink T2 Lvl 2</td><td>72,000</td><td>870</td><td>145</td><td>20</td></tr>
            <tr><td>Pink T2 Lvl 3</td><td>74,000</td><td>900</td><td>150</td><td>20</td></tr>
            <tr><td>Pink T3 Lvl 0</td><td>77,000</td><td>950</td><td>160</td><td>25</td></tr>
            <tr><td>Pink T3 Lvl 1</td><td>80,000</td><td>990</td><td>165</td><td>25</td></tr>
            <tr><td>Pink T3 Lvl 2</td><td>83,000</td><td>1,030</td><td>170</td><td>25</td></tr>
            <tr><td>Pink T3 Lvl 3</td><td>86,000</td><td>1,070</td><td>180</td><td>25</td></tr>
        </tbody>
    </table>
    <p class="note" style="color: green; font-weight: bold;">
        Note: Each gear has multiple levels across different rarities. The resources listed are cumulative per upgrade.
    </p>
</div>
</section>
        <!-- Chief Charms Calculator -->
<section id="chief-charms" class="calculator-section">
    <h2><i class="fas fa-gem"></i> Chief Charms Calculator</h2>
    <p>Select current and target levels for each of the 6 gears below:</p>
    <div id="charms-container"></div>
    <button id="calculate-charms">
        <i class="fas fa-calculator"></i> Calculate Resource Requirements
    </button>
    <div id="charms-result" class="result" style="display: none;">
        <h3><i class="fas fa-clipboard-check"></i> Calculation Results</h3>
        <p>Total Charm Guides Needed: <span id="total-guides">0</span></p>
        <p>Total Charm Designs Needed: <span id="total-designs">0</span></p>
        <p>Total Jewel Secrets Needed: <span id="total-secrets">0</span></p>
        <h3 style="margin-top: 20px;"><i class="fas fa-list-ol"></i> Upgrade Breakdown</h3>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Gear</th>
                        <th>Charm</th>
                        <th>From Level</th>
                        <th>To Level</th>
                        <th>Charm Guides</th>
                        <th>Charm Designs</th>
                        <th>Jewel Secrets</th>
                    </tr>
                </thead>
                <tbody id="steps-body-charms"></tbody>
            </table>
        </div>
    </div>
    <div class="requirements-table">
    <h3><i class="fas fa-table"></i> Charm Upgrade Requirements</h3>
    <table>
        <thead>
            <tr>
                <th>Charm Level</th>
                <th>Charm Guides</th>
                <th>Charm Designs</th>
                <th>Jewel Secrets</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Level 1 → 2</td><td>40</td><td>15</td><td>-</td></tr>
            <tr><td>Level 2 → 3</td><td>60</td><td>40</td><td>-</td></tr>
            <tr><td>Level 3 → 4</td><td>80</td><td>100</td><td>-</td></tr>
            <tr><td>Level 4 → 5</td><td>100</td><td>200</td><td>-</td></tr>
            <tr><td>Level 5 → 6</td><td>120</td><td>300</td><td>-</td></tr>
            <tr><td>Level 6 → 7</td><td>140</td><td>400</td><td>-</td></tr>
            <tr><td>Level 7 → 8</td><td>200</td><td>400</td><td>-</td></tr>
            <tr><td>Level 8 → 9</td><td>300</td><td>400</td><td>-</td></tr>
            <tr><td>Level 9 → 10</td><td>420</td><td>420</td><td>-</td></tr>
            <tr><td>Level 10 → 11</td><td>560</td><td>420</td><td>-</td></tr>
            <tr><td>Level 11 → 12</td><td>580</td><td>450</td><td>15</td></tr>
            <tr><td>Level 12 → 13</td><td>580</td><td>450</td><td>30</td></tr>
            <tr><td>Level 13 → 14</td><td>600</td><td>500</td><td>45</td></tr>
            <tr><td>Level 14 → 15</td><td>600</td><td>500</td><td>70</td></tr>
            <tr><td>Level 15 → 16</td><td>650</td><td>550</td><td>100</td></tr>
        </tbody>
    </table>
    <p class="note" style="color: green; font-weight: bold;">
        Note: Jewel Secrets are required only from Level 12 onward. All other upgrades use Charm Guides and Charm Designs.
    </p>
</div>
</section>

        <!-- Map Planner Section -->
        <section id="map-planner" class="calculator-section">
            <div class="map-planner-container">
                <div class="map-planner-header">
                    <h2><i class="fas fa-map-marked-alt"></i> Base Map Planner</h2>
                    <p>Design and optimize your base layout before building in-game</p>
                </div>
                
                <div class="map-planner-content">
                    <div class="map-planner-grid-container">
                        <div class="map-planner-toolbar">
                            <button class="map-planner-toolbar-btn" id="map-place-btn">
                                <i class="fas fa-plus-circle"></i>
                                <span>Place</span>
                            </button>
                            <button class="map-planner-toolbar-btn" id="map-place-single-btn">
                                <i class="fas fa-plus-square"></i>
                                <span>Single</span>
                            </button>
                            <button class="map-planner-toolbar-btn danger" id="map-delete-btn">
                                <i class="fas fa-trash-alt"></i>
                                <span>Delete</span>
                            </button>
                            <button class="map-planner-toolbar-btn secondary" id="map-clear-btn">
                                <i class="fas fa-broom"></i>
                                <span>Clear</span>
                            </button>
                            <button class="map-planner-toolbar-btn success" id="map-download-btn">
                                <i class="fas fa-download"></i>
                                <span>Export</span>
                            </button>
                            <button class="map-planner-toolbar-btn secondary" id="map-multi-select-btn">
                                <i class="fas fa-object-group"></i>
                                <span>Multi-Select</span>
                            </button>
                        </div>
                        
                        <div class="map-planner-grid-wrapper" id="map-grid-wrapper">
                            <div class="map-planner-grid" id="map-grid"></div>
                        </div>
                        
                        <div class="map-planner-zoom-controls">
                            <button class="map-planner-zoom-btn" id="map-zoom-in-btn">
                                <i class="fas fa-search-plus"></i> Zoom In
                            </button>
                            <button class="map-planner-zoom-btn" id="map-zoom-out-btn">
                                <i class="fas fa-search-minus"></i> Zoom Out
                            </button>
                            <button class="map-planner-zoom-btn" id="map-zoom-reset-btn">
                                <i class="fas fa-search"></i> Reset
                            </button>
                        </div>
                        
                        <div class="map-planner-grid-info">
                            <div class="map-planner-grid-info-item">
                                <span class="map-planner-grid-info-label">Total Objects</span>
                                <span class="map-planner-grid-info-value" id="map-total-objects">0</span>
                            </div>
                            <div class="map-planner-grid-info-item">
                                <span class="map-planner-grid-info-label">Grid Size</span>
                                <span class="map-planner-grid-info-value" id="map-grid-size">26×16</span>
                            </div>
                            <div class="map-planner-grid-info-item">
                                <span class="map-planner-grid-info-label">Utilization</span>
                                <span class="map-planner-grid-info-value" id="map-grid-utilization">0%</span>
                            </div>
                        </div>
                        
                        <div class="map-planner-layout-controls">
                            
                            <div class="map-planner-control-group">
                                <h3><i class="fas fa-border-style"></i> Grid Settings</h3>
                                <div class="map-planner-form-group">
                                    <label for="map-grid-cols"><i class="fas fa-columns"></i> Columns</label>
                                    <input type="number" id="map-grid-cols" min="15" max="1000" value="26">
                                </div>
                                <div class="map-planner-form-group">
                                    <label for="map-grid-rows"><i class="fas fa-stream"></i> Rows</label>
                                    <input type="number" id="map-grid-rows" min="15" max="1000" value="16">
                                </div>
                                <div class="map-planner-layout-buttons">
                                    <button class="map-planner-toolbar-btn primary" id="map-update-grid-btn">
                                        <i class="fas fa-sync-alt"></i> Update Grid
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="map-planner-notice">
                            <i class="fas fa-info-circle"></i> For best experience, use desktop view and enable multi-touch gestures on mobile devices.
                        </div>
                    </div>
                    
                    <div class="map-planner-controls">
                        <div class="map-planner-control-group">
                            <h3><i class="fas fa-cube"></i> Object Settings</h3>
                            <div class="map-planner-form-group">
                                <label for="map-obj-width"><i class="fas fa-arrows-alt-h"></i> Width (cells)</label>
                                <input type="number" id="map-obj-width" min="1" max="1000" value="2">
                            </div>
                            <div class="map-planner-form-group">
                                <label for="map-obj-height"><i class="fas fa-arrows-alt-v"></i> Height (cells)</label>
                                <input type="number" id="map-obj-height" min="1" max="1000" value="2">
                            </div>
                            <div class="map-planner-form-group">
                                <label><i class="fas fa-palette"></i> Color</label>
                                <div class="map-planner-color-options">
                                    <div class="map-planner-color-option selected" style="background: #3498db;" data-color="blue">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="map-planner-color-option" style="background: #e74c3c;" data-color="red">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="map-planner-color-option" style="background: #2ecc71;" data-color="green">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="map-planner-color-option" style="background: #9b59b6;" data-color="purple">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="map-planner-color-option" style="background: #e67e22;" data-color="orange">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="map-planner-custom-color-container">
                                    <span class="map-planner-custom-color-label">Custom:</span>
                                    <div class="map-planner-color-option" style="background: #3498db;" data-color="custom">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <input type="color" class="map-planner-custom-color-input" id="map-custom-color-input" value="#3498db">
                                </div>
                            </div>
                            <div class="map-planner-form-group">
                                <label for="map-obj-label"><i class="fas fa-tag"></i> Label (optional)</label>
                                <input type="text" id="map-obj-label" placeholder="E.g. Barracks, Hospital">
                            </div>
                        </div>
                        <div class="map-planner-control-group">
                                <h3><i class="fas fa-mouse-pointer"></i> Current Selection</h3>
                                <div class="map-planner-selection-info" id="map-selection-info">
                                    No object selected. Click on an object to select it.
                                </div>
                                <div class="map-planner-multi-select-info" id="map-multi-select-info" style="display: none;">
                                    <i class="fas fa-info-circle"></i> Multi-select mode: Hold Shift to select multiple objects
                                </div>
                            </div>
                        <div class="map-planner-control-group">
                            <h3><i class="fas fa-save"></i> Save/Load Layout</h3>
                            <div class="map-planner-form-group">
                                <label for="map-layout-name"><i class="fas fa-file-signature"></i> Layout Name</label>
                                <input type="text" id="map-layout-name" placeholder="Enter layout name">
                            </div>
                            <div class="map-planner-form-group">
                                <label for="map-load-layout"><i class="fas fa-folder-open"></i> Load Layout</label>
                                <select id="map-load-layout">
                                    <option value="">Select a saved layout</option>
                                </select>
                            </div>
                            <div class="map-planner-layout-buttons">
                                <button class="map-planner-toolbar-btn primary" id="map-save-layout-btn">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button class="map-planner-toolbar-btn" id="map-load-layout-btn">
                                    <i class="fas fa-folder-open"></i> Load
                                </button>
                                <button class="map-planner-toolbar-btn danger" id="map-delete-layout-btn">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                            <div class="map-planner-form-group">
                                <label for="map-import-layouts"><i class="fas fa-file-import"></i> Import Layouts</label>
                                <input type="file" id="map-import-layouts" accept=".json">
                            </div>
                            <div class="map-planner-layout-buttons">
                                <button class="map-planner-toolbar-btn success" id="map-export-layouts-btn">
                                    <i class="fas fa-file-export"></i> Export
                                </button>
                                <button class="map-planner-toolbar-btn" id="map-import-layouts-btn">
                                    <i class="fas fa-file-import"></i> Import
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Status message element -->
    <div class="map-planner-status" id="map-status-message"></div>

    <script>
        // Navigation between calculators
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('nav li').forEach(item => item.classList.remove('active'));
                e.target.parentElement.classList.add('active');
                const sectionId = e.target.getAttribute('data-section');
                document.querySelectorAll('.calculator-section').forEach(section => section.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
            });
        });

        // Shard Transition Map
        const shardTransitions = {
            "0_0_to_0_1": 1,
            "0_1_to_0_2": 1,
            "0_2_to_0_3": 2,
            "0_3_to_0_4": 2,
            "0_4_to_0_5": 2,
            "0_5_to_1_0": 2,

            "1_0_to_1_1": 5,
            "1_1_to_1_2": 5,
            "1_2_to_1_3": 5,
            "1_3_to_1_4": 5,
            "1_4_to_1_5": 5,
            "1_5_to_2_0": 15,

            "2_0_to_2_1": 15,
            "2_1_to_2_2": 15,
            "2_2_to_2_3": 15,
            "2_3_to_2_4": 15,
            "2_4_to_2_5": 15,
            "2_5_to_3_0": 40,

            "3_0_to_3_1": 40,
            "3_1_to_3_2": 40,
            "3_2_to_3_3": 40,
            "3_3_to_3_4": 40,
            "3_4_to_3_5": 40,
            "3_5_to_4_0": 100,

            "4_0_to_4_1": 100,
            "4_1_to_4_2": 100,
            "4_2_to_4_3": 100,
            "4_3_to_4_4": 100,
            "4_4_to_4_5": 100,
            "4_5_to_5_0": 100
        };

        // Update tier options based on star selection
        // Update tier options based on star selection
function updateTierOptions(starSelectId, tierSelectId, isCurrent = false) {
    const starSelect = document.getElementById(starSelectId);
    const tierSelect = document.getElementById(tierSelectId);
    const currentStar = parseInt(starSelect.value);
    const savedTier = tierSelect.value;
    tierSelect.innerHTML = '';
    if (currentStar === 5) {
        // Disable tier selection for 5-star heroes
        const option = document.createElement('option');
        option.textContent = 'Max (No Tiers)';
        option.disabled = true;
        tierSelect.appendChild(option);
        tierSelect.value = '0'; // Reset value but keep it disabled
    } else {
        for (let i = 0; i <= 5; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Tier ${i}`;
            tierSelect.appendChild(option);
        }
        tierSelect.value = savedTier || (isCurrent ? '0' : '5');
    }
}
function calculateShards() {
    const currentStar = parseInt(document.getElementById('current-star').value);
    const currentTier = parseInt(document.getElementById('current-tier').value);
    const targetStar = parseInt(document.getElementById('target-star').value);
    const targetTier = parseInt(document.getElementById('target-tier').value);
    const currentShards = parseInt(document.getElementById('current-shards').value) || 0;

    // Reset results
    document.getElementById('shards-result').style.display = 'none';
    document.getElementById('upgrade-steps').style.display = 'none';
    document.getElementById('steps-body').innerHTML = '';

    // Validate input
    if (currentStar > targetStar || 
        (currentStar === targetStar && currentTier > targetTier)) {
        alert('Target level must be higher than current level!');
        return;
    }

    // Special case: already at max level
    if (currentStar === 5 && targetStar === 5) {
        document.getElementById('total-shards').textContent = 0;
        document.getElementById('final-shards').textContent = Math.max(0, 0 - currentShards);
        document.getElementById('shards-result').style.display = 'block';
        return;
    }

    let totalShards = 0;
    let cs = currentStar, ct = currentTier;
    let stepsHTML = '';
    let starRows = {};

    // Initialize star rows
    for (let star = currentStar; star <= targetStar; star++) {
        starRows[star] = {
            tiers: [0, 0, 0, 0, 0],
            promote: 0,
            total: 0
        };
    }

    while (!(cs === targetStar && ct === targetTier)) {
        if (cs === 5) break;

        if (ct < 5 && (cs < targetStar || ct < targetTier)) {
            // Tier upgrade
            const stepKey = `${cs}_${ct}_to_${cs}_${ct + 1}`;
            const stepCost = shardTransitions[stepKey] || 0;
            starRows[cs].tiers[ct] = (starRows[cs].tiers[ct] || 0) + stepCost;
            starRows[cs].total += stepCost;
            totalShards += stepCost;
            ct++;
        } else if (cs < targetStar) {
            // Star promotion
            const stepKey = `${cs}_5_to_${cs + 1}_0`;
            const stepCost = shardTransitions[stepKey] || 0;
            starRows[cs].promote = stepCost;
            starRows[cs].total += stepCost;
            totalShards += stepCost;
            cs++;
            ct = 0;
        } else {
            break;
        }
    }

    // Build the table rows
    for (let star = currentStar; star < targetStar; star++) {  // Changed <= to < to exclude targetStar
    if (starRows[star] && starRows[star].total > 0) {      // Added check for total > 0
        const row = starRows[star];
        stepsHTML += `
            <tr>
                <td>${star}★ → ${star+1}★</td>
                <td>${row.tiers[0] || '-'}</td>
                <td>${row.tiers[1] || '-'}</td>
                <td>${row.tiers[2] || '-'}</td>
                <td>${row.tiers[3] || '-'}</td>
                <td>${row.tiers[4] || '-'}</td>
                <td>${row.promote || '-'}</td>
                <td>${row.total}</td>
            </tr>`;
    }
}
    const finalShards = Math.max(0, totalShards - currentShards);
    document.getElementById('total-shards').textContent = totalShards;
    document.getElementById('final-shards').textContent = finalShards;
    document.getElementById('steps-body').innerHTML = stepsHTML;
    
    // Show results
    document.getElementById('shards-result').style.display = 'block';
    if (stepsHTML) {
        document.getElementById('upgrade-steps').style.display = 'block';
    }
}
        // Gear Resources Data
        const gearResources = {
            "green_0": { alloy: 1500, solution: 15, design: 0, amber: 0 },
            "green_1": { alloy: 3800, solution: 40, design: 0, amber: 0 },
            "blue_0": { alloy: 7000, solution: 70, design: 0, amber: 0 },
            "blue_1": { alloy: 9700, solution: 95, design: 0, amber: 0 },
            "blue_2": { alloy: 0, solution: 0, design: 45, amber: 0 },
            "blue_3": { alloy: 0, solution: 0, design: 50, amber: 0 },
            "purple_0": { alloy: 0, solution: 0, design: 60, amber: 0 },
            "purple_1": { alloy: 0, solution: 0, design: 70, amber: 0 },
            "purple_2": { alloy: 6500, solution: 65, design: 40, amber: 0 },
            "purple_3": { alloy: 8000, solution: 80, design: 50, amber: 0 },
            "purple_t1_0": { alloy: 10000, solution: 95, design: 60, amber: 0 },
            "purple_t1_1": { alloy: 11000, solution: 110, design: 70, amber: 0 },
            "purple_t1_2": { alloy: 13000, solution: 130, design: 85, amber: 0 },
            "purple_t1_3": { alloy: 15000, solution: 160, design: 100, amber: 0 },
            "gold_0": { alloy: 22000, solution: 220, design: 40, amber: 0 },
            "gold_1": { alloy: 23000, solution: 230, design: 40, amber: 0 },
            "gold_2": { alloy: 25000, solution: 250, design: 45, amber: 0 },
            "gold_3": { alloy: 26000, solution: 260, design: 45, amber: 0 },
            "gold_t1_0": { alloy: 28000, solution: 280, design: 45, amber: 0 },
            "gold_t1_1": { alloy: 30000, solution: 300, design: 55, amber: 0 },
            "gold_t1_2": { alloy: 32000, solution: 320, design: 55, amber: 0 },
            "gold_t1_3": { alloy: 35000, solution: 340, design: 55, amber: 0 },
            "gold_t2_0": { alloy: 38000, solution: 390, design: 55, amber: 0 },
            "gold_t2_1": { alloy: 43000, solution: 430, design: 75, amber: 0 },
            "gold_t2_2": { alloy: 45000, solution: 460, design: 80, amber: 0 },
            "gold_t2_3": { alloy: 48000, solution: 500, design: 85, amber: 0 },
            "pink_0": { alloy: 50000, solution: 530, design: 85, amber: 10 },
            "pink_1": { alloy: 52000, solution: 560, design: 90, amber: 10 },
            "pink_2": { alloy: 54000, solution: 590, design: 95, amber: 10 },
            "pink_3": { alloy: 56000, solution: 620, design: 100, amber: 10 },
            "pink_t1_0": { alloy: 59000, solution: 670, design: 110, amber: 15 },
            "pink_t1_1": { alloy: 61000, solution: 700, design: 115, amber: 15 },
            "pink_t1_2": { alloy: 63000, solution: 730, design: 120, amber: 15 },
            "pink_t1_3": { alloy: 65000, solution: 760, design: 125, amber: 15 },
            "pink_t2_0": { alloy: 68000, solution: 810, design: 135, amber: 20 },
            "pink_t2_1": { alloy: 70000, solution: 840, design: 140, amber: 20 },
            "pink_t2_2": { alloy: 72000, solution: 870, design: 145, amber: 20 },
            "pink_t2_3": { alloy: 74000, solution: 900, design: 150, amber: 20 },
            "pink_t3_0": { alloy: 77000, solution: 950, design: 160, amber: 25 },
            "pink_t3_1": { alloy: 80000, solution: 990, design: 165, amber: 25 },
            "pink_t3_2": { alloy: 83000, solution: 1030, design: 170, amber: 25 },
            "pink_t3_3": { alloy: 86000, solution: 1070, design: 180, amber: 25 }
        };

        const gearNames = [
            { value: "cap", label: "Cap (Lancer)" },
            { value: "watch", label: "Watch (Lancer)" },
            { value: "coat", label: "Coat (Infantry)" },
            { value: "pants", label: "Pants (Infantry)" },
            { value: "belt", label: "Belt (Marksman)" },
            { value: "staff", label: "Staff (Marksman)" }
        ];

       function createGearSelector(index) {
    const gearDiv = document.createElement("div");
    gearDiv.className = "gear-block";
    gearDiv.innerHTML = `
        <h4>${gearNames[index].label}</h4>
        <div class="gear-level-selector">
            <div class="form-group">
                <label>Current Level</label>
                <select class="current-level">
                    ${generateLevelOptions()}
                </select>
            </div>
            <div class="form-group">
                <label>Target Level</label>
                <select class="target-level">
                    ${generateLevelOptions()}
                </select>
            </div>
            <div class="gear-preview">
                <img src="icons/${gearNames[index].value}.png" alt="${gearNames[index].label}">
            </div>
        </div>
    `;
    return gearDiv;
}
function calculateGearUpgrade(current, target) {
    const levels = Object.keys(gearResources);
    const startIdx = levels.indexOf(current);
    const endIdx = levels.indexOf(target);
    
    let resources = {
        alloy: 0,
        solution: 0,
        design: 0,
        amber: 0,
        steps: []
    };
    
    for (let i = startIdx + 1; i <= endIdx; i++) {
        const res = gearResources[levels[i]];
        resources.alloy += res.alloy;
        resources.solution += res.solution;
        resources.design += res.design;
        resources.amber += res.amber;
        resources.steps.push({
            from: levels[i-1],
            to: levels[i],
            costs: res
        });
    }
    
    return resources;
}
function displayGearResults(total, owned, steps) {
    // Update summary totals
    document.getElementById("alloy-needed").textContent = total.alloy.toLocaleString();
    document.getElementById("solution-needed").textContent = total.solution.toLocaleString();
    document.getElementById("design-needed").textContent = total.design.toLocaleString();
    document.getElementById("amber-needed").textContent = total.amber.toLocaleString();

    // Calculate final needed
    document.getElementById("final-alloy").textContent = Math.max(0, total.alloy - owned.alloy).toLocaleString();
    document.getElementById("final-solution").textContent = Math.max(0, total.solution - owned.solution).toLocaleString();
    document.getElementById("final-design").textContent = Math.max(0, total.design - owned.design).toLocaleString();
    document.getElementById("final-amber").textContent = Math.max(0, total.amber - owned.amber).toLocaleString();

    // Build detailed steps table (without including the header again)
    let stepsHTML = `<tbody>`;
    steps.forEach(gearSteps => {
        gearSteps.steps.forEach((step, i) => {
            stepsHTML += `
                <tr>
                    ${i === 0 ? `<td rowspan="${gearSteps.steps.length}" class="gear-name">${gearSteps.name}</td>` : ''}
                    <td>${formatLevelName(step.from)}</td>
                    <td>${formatLevelName(step.to)}</td>
                    <td>${step.costs.alloy.toLocaleString()}</td>
                    <td>${step.costs.solution.toLocaleString()}</td>
                    <td>${step.costs.design ? step.costs.design.toLocaleString() : '-'}</td>
                    <td>${step.costs.amber ? step.costs.amber.toLocaleString() : '-'}</td>
                </tr>`;
        });
    });
    stepsHTML += `</tbody>`;
    
    // Replace only the tbody content
    document.getElementById("steps-body-gears").innerHTML = stepsHTML;

    // Show result sections
    document.getElementById("gear-result").style.display = "block";
    document.getElementById("upgrade-steps-gears").style.display = "block";
}

function formatLevelName(level) {
    return level.replace(/_/g, ' ').toUpperCase();
}
        function generateLevelOptions() {
            const levels = Object.keys(gearResources);
            let options = '';
            levels.forEach(level => {
                const label = level.replace(/_/g, ' ').toUpperCase();
                options += `<option value="${level}">${label}</option>`;
            });
            return options;
        }

// --- CHIEF CHARMS LOGIC ---
const charmGearNames = [
    { value: "cap", label: "Cap (Lancer)", charms: ["1", "2", "3"] },
    { value: "watch", label: "Watch (Lancer)", charms: ["1", "2", "3"] },
    { value: "coat", label: "Coat (Infantry)", charms: ["1", "2", "3"] },
    { value: "pants", label: "Pants (Infantry)", charms: ["1", "2", "3"] },
    { value: "belt", label: "Belt (Marksman)", charms: ["1", "2", "3"] },
    { value: "staff", label: "Staff (Marksman)", charms: ["1", "2", "3"] }
];

const charmLevels = [
    { level: 1, guides: 5, designs: 5, secrets: 0, power: 205700 },
    { level: 2, guides: 40, designs: 15, secrets: 0, power: 288000 },
    { level: 3, guides: 60, designs: 40, secrets: 0, power: 370000 },
    { level: 4, guides: 80, designs: 100, secrets: 0, power: 452000 },
    { level: 5, guides: 100, designs: 200, secrets: 0, power: 576000 },
    { level: 6, guides: 120, designs: 300, secrets: 0, power: 700000 },
    { level: 7, guides: 140, designs: 400, secrets: 0, power: 824000 },
    { level: 8, guides: 200, designs: 400, secrets: 0, power: 948000 },
    { level: 9, guides: 300, designs: 400, secrets: 0, power: 1072000 },
    { level: 10, guides: 420, designs: 420, secrets: 0, power: 1196000 },
    { level: 11, guides: 560, designs: 420, secrets: 0, power: 1320000 },
    { level: 12, guides: 580, designs: 450, secrets: 15, power: 0 },
    { level: 13, guides: 580, designs: 450, secrets: 30, power: 0 },
    { level: 14, guides: 600, designs: 500, secrets: 45, power: 0 },
    { level: 15, guides: 600, designs: 500, secrets: 70, power: 0 },
    { level: 16, guides: 650, designs: 550, secrets: 100, power: 0 }
];

function createCharmsSelector(gearIndex) {
    const gearDiv = document.createElement("div");
    gearDiv.className = "gear-group";
    const header = document.createElement("div");
    header.className = "gear-header";
    header.textContent = charmGearNames[gearIndex].label;
    gearDiv.appendChild(header);
    const charmRow = document.createElement("div");
    charmRow.className = "charm-row";
    charmGearNames[gearIndex].charms.forEach((charm, charmIndex) => {
        const charmSet = document.createElement("div");
        charmSet.className = "charm-set";
        const title = document.createElement("h4");
        title.textContent = `${charm} Charm`;
        charmSet.appendChild(title);

        // Current Level Selector
        const currentContainer = document.createElement("div");
        currentContainer.className = "form-group";
        const currentLabel = document.createElement("label");
        currentLabel.textContent = "Current Level";
        currentContainer.appendChild(currentLabel);
        const currentSelect = document.createElement("select");
        currentSelect.className = `current-level ${charmGearNames[gearIndex].value}-${charmIndex}`;
        charmLevels.forEach(level => {
            const option = document.createElement("option");
            option.value = level.level;
            option.textContent = `Level ${level.level}`;
            currentSelect.appendChild(option);
        });
        currentContainer.appendChild(currentSelect);
        charmSet.appendChild(currentContainer);

        // Target Level Selector
        const targetContainer = document.createElement("div");
        targetContainer.className = "form-group";
        const targetLabel = document.createElement("label");
        targetLabel.textContent = "Target Level";
        targetContainer.appendChild(targetLabel);
        const targetSelect = document.createElement("select");
        targetSelect.className = `target-level ${charmGearNames[gearIndex].value}-${charmIndex}`;
        charmLevels.forEach(level => {
            const option = document.createElement("option");
            option.value = level.level;
            option.textContent = `Level ${level.level}`;
            targetSelect.appendChild(option);
        });
        targetContainer.appendChild(targetSelect);
        charmSet.appendChild(targetContainer);

        charmRow.appendChild(charmSet);
    });
    gearDiv.appendChild(charmRow);
    return gearDiv;
}

function calculateCharms() {
    let totalGuides = 0, totalDesigns = 0, totalSecrets = 0;
    let stepsHTML = "";
    charmGearNames.forEach((gear, gearIndex) => {
        gear.charms.forEach((charm, charmIndex) => {
            const currentSelect = document.querySelector(`select.current-level.${gear.value}-${charmIndex}`);
            const targetSelect = document.querySelector(`select.target-level.${gear.value}-${charmIndex}`);
            if (!currentSelect || !targetSelect) return;
            const currentLevel = parseInt(currentSelect.value);
            const targetLevel = parseInt(targetSelect.value);
            if (currentLevel >= targetLevel) return;

            const currentIdx = charmLevels.findIndex(l => l.level === currentLevel);
            const targetIdx = charmLevels.findIndex(l => l.level === targetLevel);
            if (currentIdx === -1 || targetIdx === -1 || currentIdx >= targetIdx) return;

            for (let i = currentIdx + 1; i <= targetIdx; i++) {
                totalGuides += charmLevels[i].guides;
                totalDesigns += charmLevels[i].designs;
                totalSecrets += charmLevels[i].secrets;
                stepsHTML += `
                    <tr>
                        <td>${gear.label}</td>
                        <td>${charm}</td>
                        <td>${charmLevels[i-1].level}</td>
                        <td>${charmLevels[i].level}</td>
                        <td>${charmLevels[i].guides}</td>
                        <td>${charmLevels[i].designs}</td>
                        <td>${charmLevels[i].secrets > 0 ? charmLevels[i].secrets : "-"}</td>
                    </tr>`;
            }
        });
    });

    document.getElementById("total-guides").textContent = totalGuides.toLocaleString();
    document.getElementById("total-designs").textContent = totalDesigns.toLocaleString();
    document.getElementById("total-secrets").textContent = totalSecrets.toLocaleString();
    document.getElementById("steps-body-charms").innerHTML = stepsHTML;
    document.getElementById("charms-result").style.display = "block";
}

// --- MAP PLANNER LOGIC ---
document.addEventListener('DOMContentLoaded', () => {
            // Initialize elements
            const mapGridWrapper = document.getElementById('map-grid-wrapper');
            const mapGrid = document.getElementById('map-grid');
            const mapGridColsInput = document.getElementById('map-grid-cols');
            const mapGridRowsInput = document.getElementById('map-grid-rows');
            const mapUpdateGridBtn = document.getElementById('map-update-grid-btn');
            const mapObjWidthInput = document.getElementById('map-obj-width');
            const mapObjHeightInput = document.getElementById('map-obj-height');
            const mapObjLabelInput = document.getElementById('map-obj-label');
            const mapPlaceBtn = document.getElementById('map-place-btn');
            const mapPlaceSingleBtn = document.getElementById('map-place-single-btn');
            const mapDeleteBtn = document.getElementById('map-delete-btn');
            const mapClearBtn = document.getElementById('map-clear-btn');
            const mapDownloadBtn = document.getElementById('map-download-btn');
            const mapMultiSelectBtn = document.getElementById('map-multi-select-btn');
            const mapColorOptions = document.querySelectorAll('.map-planner-color-option');
            const mapCustomColorInput = document.getElementById('map-custom-color-input');
            const mapSelectionInfo = document.getElementById('map-selection-info');
            const mapMultiSelectInfo = document.getElementById('map-multi-select-info');
            const mapZoomInBtn = document.getElementById('map-zoom-in-btn');
            const mapZoomOutBtn = document.getElementById('map-zoom-out-btn');
            const mapZoomResetBtn = document.getElementById('map-zoom-reset-btn');
            const mapTotalObjectsSpan = document.getElementById('map-total-objects');
            const mapGridSizeSpan = document.getElementById('map-grid-size');
            const mapGridUtilizationSpan = document.getElementById('map-grid-utilization');
            const mapLayoutNameInput = document.getElementById('map-layout-name');
            const mapLoadLayoutSelect = document.getElementById('map-load-layout');
            const mapSaveLayoutBtn = document.getElementById('map-save-layout-btn');
            const mapLoadLayoutBtn = document.getElementById('map-load-layout-btn');
            const mapDeleteLayoutBtn = document.getElementById('map-delete-layout-btn');
            const mapExportLayoutsBtn = document.getElementById('map-export-layouts-btn');
            const mapImportLayoutsInput = document.getElementById('map-import-layouts');
            const mapImportLayoutsBtn = document.getElementById('map-import-layouts-btn');
            const mapStatusMessage = document.getElementById('map-status-message');

            // Constants
            const CELL_SIZE = 30;
            let gridCols = 26;
            let gridRows = 16;
            let objWidth = 2;
            let objHeight = 2;
            let selectedColor = 'blue';
            let customColor = '#3498db';
            let objects = [];
            let selectedObjects = [];
            let isPlacing = false;
            let isSinglePlacement = false;
            let isMultiSelect = false;
            let placingObject = null;
            let currentZoom = 1;
            let isDragging = false;
            let draggedObject = null;
            let dragStartRow = 0;
            let dragStartCol = 0;
            let dragRowOffset = 0;
            let dragColOffset = 0;

            // Initialize
            initializeMapGrid();
            setupMapEventListeners();
            updateSavedLayouts();

            function initializeMapGrid() {
                gridCols = parseInt(mapGridColsInput.value);
                gridRows = parseInt(mapGridRowsInput.value);

                mapGrid.style.gridTemplateColumns = `repeat(${gridCols}, ${CELL_SIZE}px)`;
                mapGrid.style.gridTemplateRows = `repeat(${gridRows}, ${CELL_SIZE}px)`;
                mapGrid.style.width = `${gridCols * CELL_SIZE}px`;
                mapGrid.style.height = `${gridRows * CELL_SIZE}px`;

                mapGridSizeSpan.textContent = `${gridCols}×${gridRows}`;
                currentZoom = 1;
                mapGrid.style.transform = `scale(${currentZoom})`;

                mapGrid.innerHTML = '';
                for (let i = 0; i < gridRows; i++) {
                    for (let j = 0; j < gridCols; j++) {
                        const cell = document.createElement('div');
                        cell.classList.add('map-planner-grid-cell');
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        cell.style.margin = '0';
                        cell.style.padding = '0';
                        mapGrid.appendChild(cell);
                    }
                }
                mapGridWrapper.scrollTo(0, 0);
                centerMapGrid();
                updateMapStats();
            }

            function centerMapGrid() {
                mapGridWrapper.scrollTo(
                    (gridCols * CELL_SIZE * currentZoom - mapGridWrapper.clientWidth) / 2,
                    (gridRows * CELL_SIZE * currentZoom - mapGridWrapper.clientHeight) / 2
                );
            }

            function setupMapEventListeners() {
                // Grid configuration
                mapUpdateGridBtn.addEventListener('click', () => {
                    initializeMapGrid();
                    objects = [];
                    selectedObjects = [];
                    updateMapSelectionInfo();
                    updateMapStats();
                });

                // Object placement mode
                mapPlaceBtn.addEventListener('click', toggleMapPlacementMode);
                mapPlaceSingleBtn.addEventListener('click', toggleMapSinglePlacementMode);

                // Multi-select mode
                mapMultiSelectBtn.addEventListener('click', () => {
                    isMultiSelect = !isMultiSelect;
                    mapMultiSelectBtn.classList.toggle('active', isMultiSelect);
                    mapMultiSelectInfo.style.display = isMultiSelect ? 'block' : 'none';
                    if (!isMultiSelect && selectedObjects.length > 1) {
                        clearMapSelection();
                    }
                });

                // Color selection
                mapColorOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        mapColorOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        selectedColor = option.dataset.color;
                        if (selectedColor === 'custom') {
                            const customOption = document.querySelector('.map-planner-color-option[data-color="custom"]');
                            customOption.style.backgroundColor = customColor;
                        }
                        if (placingObject) {
                            updateMapPlacingObjectColor();
                        }
                        if (selectedObjects.length > 0) {
                            updateMapSelectedObjectsColor();
                        }
                    });
                });

                // Custom color input
                mapCustomColorInput.addEventListener('input', (e) => {
                    customColor = e.target.value;
                    if (selectedColor === 'custom') {
                        const customOption = document.querySelector('.map-planner-color-option[data-color="custom"]');
                        customOption.style.backgroundColor = customColor;
                        if (placingObject) {
                            updateMapPlacingObjectColor();
                        }
                        if (selectedObjects.length > 0) {
                            updateMapSelectedObjectsColor();
                        }
                    }
                });

                // Object deletion
                mapDeleteBtn.addEventListener('click', deleteMapSelectedObjects);

                // Clear all objects
                mapClearBtn.addEventListener('click', () => {
                    objects.forEach(obj => obj.element.remove());
                    objects = [];
                    selectedObjects = [];
                    updateMapSelectionInfo();
                    updateMapOccupiedCells();
                    updateMapStats();
                });

                // Download grid
                mapDownloadBtn.addEventListener('click', downloadMapFullGrid);

                // Zoom controls
                mapZoomInBtn.addEventListener('click', () => {
                    currentZoom = Math.min(currentZoom + 0.1, 2);
                    mapGrid.style.transform = `scale(${currentZoom})`;
                    centerMapGrid();
                });

                mapZoomOutBtn.addEventListener('click', () => {
                    currentZoom = Math.max(currentZoom - 0.1, 0.5);
                    mapGrid.style.transform = `scale(${currentZoom})`;
                    centerMapGrid();
                });

                mapZoomResetBtn.addEventListener('click', () => {
                    currentZoom = 1;
                    mapGrid.style.transform = `scale(${currentZoom})`;
                    centerMapGrid();
                });

                // Grid interaction
                mapGrid.addEventListener('mousedown', handleMapGridMouseDown);
                mapGrid.addEventListener('mousemove', handleMapGridMouseMove);
                document.addEventListener('mouseup', handleMapGridMouseUp);

                // Update placing object
                mapObjWidthInput.addEventListener('input', updateMapPlacingObject);
                mapObjHeightInput.addEventListener('input', updateMapPlacingObject);
                mapObjLabelInput.addEventListener('input', updateMapPlacingObject);

                // Save/Load/Delete layout
                mapSaveLayoutBtn.addEventListener('click', saveLayout);
                mapLoadLayoutBtn.addEventListener('click', loadLayout);
                mapDeleteLayoutBtn.addEventListener('click', deleteLayout);

                // Export/Import layouts
                mapExportLayoutsBtn.addEventListener('click', exportLayouts);
                mapImportLayoutsBtn.addEventListener('click', importLayouts);
            }

            function toggleMapPlacementMode() {
                if (isPlacing) {
                    isPlacing = false;
                    mapPlaceBtn.classList.remove('active');
                    if (placingObject) {
                        placingObject.remove();
                        placingObject = null;
                    }
                    return;
                }
                if (isSinglePlacement) {
                    isSinglePlacement = false;
                    mapPlaceSingleBtn.classList.remove('active');
                }
                isPlacing = true;
                mapPlaceBtn.classList.add('active');
                createMapPlacingObject();
            }

            function toggleMapSinglePlacementMode() {
                if (isSinglePlacement) {
                    isSinglePlacement = false;
                    mapPlaceSingleBtn.classList.remove('active');
                    if (placingObject) {
                        placingObject.remove();
                        placingObject = null;
                    }
                    return;
                }
                if (isPlacing) {
                    isPlacing = false;
                    mapPlaceBtn.classList.remove('active');
                }
                isSinglePlacement = true;
                mapPlaceSingleBtn.classList.add('active');
                createMapPlacingObject();
            }

            function updateMapPlacingObjectColor() {
                if (!placingObject) return;
                placingObject.className = 'map-planner-grid-object placing';
                placingObject.style.backgroundColor = '';
                if (selectedColor === 'custom') {
                    placingObject.style.backgroundColor = customColor;
                } else {
                    placingObject.classList.add(`map-planner-object-${selectedColor}`);
                }
            }

            function updateMapSelectedObjectsColor() {
                selectedObjects.forEach(object => {
                    object.className = 'map-planner-grid-object';
                    if (object.classList.contains('selected')) {
                        object.classList.add('selected');
                    }
                    object.style.backgroundColor = '';
                    const objData = objects.find(obj => obj.element === object);
                    if (objData) {
                        if (selectedColor === 'custom') {
                            object.style.backgroundColor = customColor;
                            objData.color = customColor;
                        } else {
                            object.classList.add(`map-planner-object-${selectedColor}`);
                            objData.color = selectedColor;
                        }
                    }
                });
            }

            function updateMapPlacingObject() {
                if (!placingObject) return;
                objWidth = parseInt(mapObjWidthInput.value);
                objHeight = parseInt(mapObjHeightInput.value);
                const label = mapObjLabelInput.value.trim() || `${objWidth}×${objHeight}`;
                placingObject.textContent = label;
                const objectWidth = objWidth * CELL_SIZE;
                const objectHeight = objHeight * CELL_SIZE;
                placingObject.style.width = `${objectWidth}px`;
                placingObject.style.height = `${objectHeight}px`;
            }

            function handleMapGridMouseDown(e) {
                const cell = e.target.closest('.map-planner-grid-cell');
                const clickedObject = e.target.closest('.map-planner-grid-object');
                
                if ((isPlacing || isSinglePlacement) && cell) {
                    if (placingObject) {
                        placingObject.remove();
                    }
                    objWidth = parseInt(mapObjWidthInput.value);
                    objHeight = parseInt(mapObjHeightInput.value);
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    if (canPlaceMapObject(row, col, objWidth, objHeight)) {
                        placeMapNewObject(row, col, objWidth, objHeight);
                        if (isSinglePlacement) {
                            isSinglePlacement = false;
                            mapPlaceSingleBtn.classList.remove('active');
                            if (placingObject) {
                                placingObject.remove();
                                placingObject = null;
                            }
                        } else if (isPlacing) {
                            createMapPlacingObject();
                        }
                    } else if (isPlacing) {
                        createMapPlacingObject();
                    }
                    return;
                }
                
                if (clickedObject && !isPlacing && !isSinglePlacement) {
                    e.preventDefault();
                    if (!e.shiftKey || !isMultiSelect) {
                        clearMapSelection();
                    }
                    selectMapObject(clickedObject, !e.shiftKey);
                    
                    if (selectedObjects.length === 1 && !isMultiSelect) {
                        isDragging = true;
                        draggedObject = clickedObject;
                        const objData = objects.find(obj => obj.element === draggedObject);
                        
                        if (objData) {
                            // Calculate the offset within the object where the user clicked
                            const rect = draggedObject.getBoundingClientRect();
                            const x = (e.clientX - rect.left) / currentZoom;
                            const y = (e.clientY - rect.top) / currentZoom;
                            
                            // Calculate which cell within the object was clicked
                            dragColOffset = Math.floor(x / CELL_SIZE);
                            dragRowOffset = Math.floor(y / CELL_SIZE);
                            
                            // Store the original position
                            dragStartRow = objData.row;
                            dragStartCol = objData.col;
                            
                            draggedObject.classList.add('dragging');
                        }
                    }
                    return;
                }
                
                if (!isMultiSelect || !e.shiftKey) {
                    clearMapSelection();
                }
            }

            function handleMapGridMouseMove(e) {
                if (isPlacing || isSinglePlacement) {
                    if (!placingObject) return;
                    const rect = mapGrid.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / currentZoom;
                    const y = (e.clientY - rect.top) / currentZoom;
                    const col = Math.floor(x / CELL_SIZE);
                    const row = Math.floor(y / CELL_SIZE);
                    const objectWidth = objWidth * CELL_SIZE;
                    const objectHeight = objHeight * CELL_SIZE;
                    const maxLeft = (gridCols - objWidth) * CELL_SIZE;
                    const maxTop = (gridRows - objHeight) * CELL_SIZE;
                    const left = Math.min(Math.max(col * CELL_SIZE, 0), maxLeft);
                    const top = Math.min(Math.max(row * CELL_SIZE, 0), maxTop);
                    placingObject.style.left = `${left}px`;
                    placingObject.style.top = `${top}px`;
                    return;
                }
                
                if (isDragging && draggedObject) {
                    const rect = mapGrid.getBoundingClientRect();
                    // Account for zoom when calculating position
                    const x = (e.clientX - rect.left) / currentZoom;
                    const y = (e.clientY - rect.top) / currentZoom;
                    
                    // Calculate the new position accounting for the offset and zoom
                    const col = Math.floor(x / CELL_SIZE) - dragColOffset;
                    const row = Math.floor(y / CELL_SIZE) - dragRowOffset;
                    
                    const objData = objects.find(obj => obj.element === draggedObject);
                    if (objData) {
                        const { width, height } = objData;
                        const maxLeft = (gridCols - width) * CELL_SIZE;
                        const maxTop = (gridRows - height) * CELL_SIZE;
                        const left = Math.min(Math.max(col * CELL_SIZE, 0), maxLeft);
                        const top = Math.min(Math.max(row * CELL_SIZE, 0), maxTop);
                        
                        draggedObject.style.left = `${left}px`;
                        draggedObject.style.top = `${top}px`;
                        
                        const isValid = canPlaceMapObject(row, col, width, height, draggedObject);
                        draggedObject.classList.toggle('valid', isValid);
                        draggedObject.classList.toggle('invalid', !isValid);
                    }
                }
            }

            function handleMapGridMouseUp(e) {
                if (isDragging && draggedObject) {
                    isDragging = false;
                    const objData = objects.find(obj => obj.element === draggedObject);
                    if (objData) {
                        const rect = mapGrid.getBoundingClientRect();
                        // Account for zoom when calculating final position
                        const x = (e.clientX - rect.left) / currentZoom;
                        const y = (e.clientY - rect.top) / currentZoom;
                        
                        // Calculate the new position accounting for the offset and zoom
                        const col = Math.floor(x / CELL_SIZE) - dragColOffset;
                        const row = Math.floor(y / CELL_SIZE) - dragRowOffset;
                        
                        const isValid = canPlaceMapObject(row, col, objData.width, objData.height, draggedObject);
                        draggedObject.classList.remove('dragging', 'valid', 'invalid');
                        
                        if (isValid) {
                            objData.row = row;
                            objData.col = col;
                            positionMapObject(draggedObject, row, col, objData.width, objData.height);
                            updateMapOccupiedCells();
                            updateMapSelectionInfo();
                            updateMapStats();
                        } else {
                            positionMapObject(draggedObject, dragStartRow, dragStartCol, objData.width, objData.height);
                        }
                    }
                    draggedObject = null;
                    dragRowOffset = 0;
                    dragColOffset = 0;
                }
            }

            function clearMapSelection() {
                selectedObjects.forEach(obj => obj.classList.remove('selected'));
                selectedObjects = [];
                updateMapSelectionInfo();
            }

            function selectMapObject(object, singleSelect = true) {
                if (singleSelect && selectedObjects.length > 0 && !selectedObjects.includes(object)) {
                    clearMapSelection();
                }
                if (!selectedObjects.includes(object)) {
                    selectedObjects.push(object);
                    object.classList.add('selected');
                    updateMapSelectionInfo();
                } else if (isMultiSelect) {
                    const index = selectedObjects.indexOf(object);
                    if (index !== -1) {
                        selectedObjects.splice(index, 1);
                        object.classList.remove('selected');
                        updateMapSelectionInfo();
                    }
                }
            }

            function updateMapSelectionInfo() {
                if (selectedObjects.length === 0) {
                    mapSelectionInfo.textContent = "No object selected";
                    return;
                }
                if (selectedObjects.length > 1) {
                    mapSelectionInfo.innerHTML = `
                        <strong>${selectedObjects.length} objects selected</strong><br>
                        Hold Shift to add/remove from selection
                    `;
                    return;
                }
                const object = selectedObjects[0];
                const objData = objects.find(obj => obj.element === object);
                if (objData) {
                    mapSelectionInfo.innerHTML = `
                        <strong>Selected Object:</strong><br>
                        Position: (${objData.col}, ${objData.row})<br>
                        Size: ${objData.width}×${objData.height}<br>
                        Color: ${objData.color}<br>
                        ${objData.label ? `Label: ${objData.label}` : ''}
                    `;
                }
            }

            function createMapPlacingObject() {
                if (placingObject) {
                    placingObject.remove();
                }
                placingObject = document.createElement('div');
                placingObject.classList.add('map-planner-grid-object', 'placing');
                if (selectedColor === 'custom') {
                    placingObject.style.backgroundColor = customColor;
                } else {
                    placingObject.classList.add(`map-planner-object-${selectedColor}`);
                }
                const label = mapObjLabelInput.value.trim() || `${mapObjWidthInput.value}×${mapObjHeightInput.value}`;
                placingObject.textContent = label;
                const objectWidth = objWidth * CELL_SIZE;
                const objectHeight = objHeight * CELL_SIZE;
                placingObject.style.width = `${objectWidth}px`;
                placingObject.style.height = `${objectHeight}px`;
                placingObject.style.left = `-${objectWidth}px`;
                placingObject.style.top = `-${objectHeight}px`;
                mapGrid.appendChild(placingObject);
            }

            function placeMapNewObject(row, col, width, height) {
                const object = document.createElement('div');
                object.classList.add('map-planner-grid-object');
                if (selectedColor === 'custom') {
                    object.style.backgroundColor = customColor;
                } else {
                    object.classList.add(`map-planner-object-${selectedColor}`);
                }
                const label = mapObjLabelInput.value.trim() || `${width}×${height}`;
                object.textContent = label;
                const objData = {
                    element: object,
                    row,
                    col,
                    width,
                    height,
                    color: selectedColor === 'custom' ? customColor : selectedColor,
                    label
                };
                objects.push(objData);
                mapGrid.appendChild(object);
                positionMapObject(object, row, col, width, height);
                updateMapOccupiedCells();
                if (placingObject) {
                    placingObject.remove();
                    placingObject = null;
                    if (isPlacing) {
                        createMapPlacingObject();
                    }
                }
                clearMapSelection();
                selectMapObject(object);
                updateMapStats();
            }

            function positionMapObject(object, row, col, width, height) {
                const left = col * CELL_SIZE;
                const top = row * CELL_SIZE;
                const maxLeft = (gridCols - width) * CELL_SIZE;
                const maxTop = (gridRows - height) * CELL_SIZE;
                const clampedLeft = Math.min(left, maxLeft);
                const clampedTop = Math.min(top, maxTop);
                object.style.width = `${width * CELL_SIZE}px`;
                object.style.height = `${height * CELL_SIZE}px`;
                object.style.left = `${clampedLeft}px`;
                object.style.top = `${clampedTop}px`;
            }

            function updateMapOccupiedCells() {
                document.querySelectorAll('.map-planner-grid-cell.occupied').forEach(cell => {
                    cell.classList.remove('occupied');
                });
                objects.forEach(obj => {
                    for (let r = obj.row; r < obj.row + obj.height; r++) {
                        for (let c = obj.col; c < obj.col + obj.width; c++) {
                            const cell = mapGrid.querySelector(`.map-planner-grid-cell[data-row="${r}"][data-col="${c}"]`);
                            if (cell) cell.classList.add('occupied');
                        }
                    }
                });
            }

            function canPlaceMapObject(row, col, width, height, excludeObject = null) {
                if (row < 0 || col < 0 || row + height > gridRows || col + width > gridCols) {
                    return false;
                }
                for (let r = row; r < row + height; r++) {
                    for (let c = col; c < col + width; c++) {
                        const cell = mapGrid.querySelector(`.map-planner-grid-cell[data-row="${r}"][data-col="${c}"]`);
                        if (cell && cell.classList.contains('occupied')) {
                            let isExcluded = false;
                            if (excludeObject) {
                                const objData = objects.find(obj => obj.element === excludeObject);
                                if (objData && r >= objData.row && r < objData.row + objData.height &&
                                    c >= objData.col && c < objData.col + objData.width) {
                                    isExcluded = true;
                                }
                            }
                            if (!isExcluded) {
                                return false;
                            }
                        }
                    }
                }
                return true;
            }

            function deleteMapSelectedObjects() {
                if (selectedObjects.length === 0) return;
                selectedObjects.forEach(object => {
                    const index = objects.findIndex(obj => obj.element === object);
                    if (index !== -1) {
                        object.remove();
                        objects.splice(index, 1);
                    }
                });
                updateMapOccupiedCells();
                selectedObjects = [];
                updateMapSelectionInfo();
                updateMapStats();
            }

            function downloadMapFullGrid() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = gridCols * CELL_SIZE;
                canvas.height = gridRows * CELL_SIZE;
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#34495e';
                for (let i = 0; i < gridRows; i++) {
                    for (let j = 0; j < gridCols; j++) {
                        ctx.fillRect(j * CELL_SIZE, i * CELL_SIZE, CELL_SIZE - 1, CELL_SIZE - 1);
                    }
                }
                objects.forEach(obj => {
                    for (let r = obj.row; r < obj.row + obj.height; r++) {
                        for (let c = obj.col; c < obj.col + obj.width; c++) {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                            ctx.fillRect(c * CELL_SIZE, r * CELL_SIZE, CELL_SIZE - 1, CELL_SIZE - 1);
                        }
                    }
                });
                objects.forEach(obj => {
                    const left = obj.col * CELL_SIZE;
                    const top = obj.row * CELL_SIZE;
                    const width = obj.width * CELL_SIZE;
                    const height = obj.height * CELL_SIZE;
                    const colorMap = {
                        'blue': '#3498db',
                        'red': '#e74c3c',
                        'green': '#2ecc71',
                        'purple': '#9b59b6',
                        'orange': '#e67e22'
                    };
                    ctx.fillStyle = obj.color.startsWith('#') ? obj.color : colorMap[obj.color] || '#3498db';
                    ctx.fillRect(left, top, width, height);
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(left, top, width, height);
                    ctx.shadowColor = 'rgba(0,0,0,0.3)';
                    ctx.shadowBlur = 2;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                    if (obj.label) {
                        ctx.font = 'bold 12px Arial';
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.shadowColor = 'rgba(0,0,0,0.8)';
                        ctx.shadowBlur = 2;
                        ctx.fillText(obj.label, left + width/2, top + height/2);
                        ctx.shadowColor = 'transparent';
                    }
                });
                const link = document.createElement('a');
                link.download = `grid-map-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function updateMapStats() {
                mapTotalObjectsSpan.textContent = objects.length;
                const totalCells = gridCols * gridRows;
                let occupiedCells = 0;
                objects.forEach(obj => {
                    occupiedCells += obj.width * obj.height;
                });
                const utilizationPercentage = totalCells > 0 ? Math.round((occupiedCells / totalCells) * 100) : 0;
                mapGridUtilizationSpan.textContent = `${utilizationPercentage}%`;
            }

            function showStatusMessage(message, duration = 3000) {
                mapStatusMessage.textContent = message;
                mapStatusMessage.classList.add('show');
                setTimeout(() => {
                    mapStatusMessage.classList.remove('show');
                }, duration);
            }

            function saveLayout() {
                const layoutName = mapLayoutNameInput.value.trim();
                if (!layoutName) {
                    showStatusMessage('Please enter a layout name.');
                    return;
                }
                const layoutData = {
                    gridCols,
                    gridRows,
                    objects: objects.map(obj => ({
                        row: obj.row,
                        col: obj.col,
                        width: obj.width,
                        height: obj.height,
                        color: obj.color,
                        label: obj.label
                    }))
                };
                let layouts;
                try {
                    layouts = JSON.parse(localStorage.getItem('mapLayouts') || '{}');
                } catch (e) {
                    showStatusMessage('Error accessing saved layouts. Please clear localStorage and try again.');
                    return;
                }
                layouts[layoutName] = layoutData;
                try {
                    localStorage.setItem('mapLayouts', JSON.stringify(layouts));
                } catch (e) {
                    showStatusMessage('Error saving layout: localStorage may be full or inaccessible.');
                    return;
                }
                mapLayoutNameInput.value = '';
                updateSavedLayouts();
                showStatusMessage(`Layout "${layoutName}" saved successfully!`);
            }

            function loadLayout() {
                const layoutName = mapLoadLayoutSelect.value;
                if (!layoutName) {
                    showStatusMessage('Please select a layout to load.');
                    return;
                }
                let layouts;
                try {
                    layouts = JSON.parse(localStorage.getItem('mapLayouts') || '{}');
                } catch (e) {
                    showStatusMessage('Error accessing saved layouts. Please clear localStorage and try again.');
                    return;
                }
                const layoutData = layouts[layoutName];
                if (!layoutData) {
                    showStatusMessage('Selected layout not found.');
                    return;
                }
                gridCols = layoutData.gridCols;
                gridRows = layoutData.gridRows;
                mapGridColsInput.value = gridCols;
                mapGridRowsInput.value = gridRows;
                initializeMapGrid();
                objects = [];
                selectedObjects = [];
                layoutData.objects.forEach(obj => {
                    const object = document.createElement('div');
                    object.classList.add('map-planner-grid-object');
                    if (obj.color.startsWith('#')) {
                        object.style.backgroundColor = obj.color;
                    } else {
                        object.classList.add(`map-planner-object-${obj.color}`);
                    }
                    object.textContent = obj.label || `${obj.width}×${obj.height}`;
                    const objData = {
                        element: object,
                        row: obj.row,
                        col: obj.col,
                        width: obj.width,
                        height: obj.height,
                        color: obj.color,
                        label: obj.label
                    };
                    objects.push(objData);
                    mapGrid.appendChild(object);
                    positionMapObject(object, obj.row, obj.col, obj.width, obj.height);
                });
                updateMapOccupiedCells();
                updateMapStats();
                clearMapSelection();
                showStatusMessage(`Layout "${layoutName}" loaded successfully!`);
            }

            function deleteLayout() {
                const layoutName = mapLoadLayoutSelect.value;
                if (!layoutName) {
                    showStatusMessage('Please select a layout to delete.');
                    return;
                }
                let layouts;
                try {
                    layouts = JSON.parse(localStorage.getItem('mapLayouts') || '{}');
                } catch (e) {
                    showStatusMessage('Error accessing saved layouts. Please clear localStorage and try again.');
                    return;
                }
                if (layouts[layoutName]) {
                    delete layouts[layoutName];
                    try {
                        localStorage.setItem('mapLayouts', JSON.stringify(layouts));
                    } catch (e) {
                        showStatusMessage('Error deleting layout: localStorage may be full or inaccessible.');
                        return;
                    }
                    updateSavedLayouts();
                    showStatusMessage(`Layout "${layoutName}" deleted successfully!`);
                } else {
                    showStatusMessage('Selected layout not found.');
                }
            }

            function updateSavedLayouts() {
                let layouts;
                try {
                    layouts = JSON.parse(localStorage.getItem('mapLayouts') || '{}');
                } catch (e) {
                    showStatusMessage('Error accessing saved layouts. Please clear localStorage and try again.');
                    return;
                }
                mapLoadLayoutSelect.innerHTML = '<option value="">Select a saved layout</option>';
                Object.keys(layouts).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    mapLoadLayoutSelect.appendChild(option);
                });
            }

            function exportLayouts() {
                let layouts;
                try {
                    layouts = localStorage.getItem('mapLayouts') || '{}';
                    const parsedLayouts = JSON.parse(layouts);
                    if (Object.keys(parsedLayouts).length === 0) {
                        showStatusMessage('No layouts to export.');
                        return;
                    }
                    const sizeInBytes = new Blob([layouts]).size;
                    const maxSize = 5 * 1024 * 1024;
                    if (sizeInBytes > maxSize) {
                        showStatusMessage('Layout data is too large to export. Try deleting some layouts.');
                        return;
                    }
                    const blob = new Blob([layouts], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `map-layouts-${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    showStatusMessage('Layouts exported successfully!');
                } catch (e) {
                    showStatusMessage('Error exporting layouts: Could not access saved layouts.');
                    console.error('Export error:', e);
                }
            }

            function importLayouts() {
                const file = mapImportLayoutsInput.files[0];
                if (!file) {
                    showStatusMessage('Please select a JSON file to import.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!isValidLayouts(importedData)) {
                            showStatusMessage('Invalid layout file format.');
                            return;
                        }
                        let existingLayouts;
                        try {
                            existingLayouts = JSON.parse(localStorage.getItem('mapLayouts') || '{}');
                        } catch (e) {
                            showStatusMessage('Error accessing existing layouts. Please clear localStorage and try again.');
                            return;
                        }
                        const updatedLayouts = { ...existingLayouts, ...importedData };
                        try {
                            localStorage.setItem('mapLayouts', JSON.stringify(updatedLayouts));
                        } catch (e) {
                            showStatusMessage('Error saving imported layouts: localStorage may be full or inaccessible.');
                            return;
                        }
                        updateSavedLayouts();
                        mapImportLayoutsInput.value = '';
                        showStatusMessage('Layouts imported successfully!');
                    } catch (error) {
                        showStatusMessage('Error importing layouts: Invalid JSON file or corrupted data.');
                        console.error('Import error:', error);
                    }
                };
                reader.onerror = function() {
                    showStatusMessage('Error reading the file. Please try again.');
                };
                reader.readAsText(file);
            }

            function isValidLayouts(data) {
                if (typeof data !== 'object' || data === null) return false;
                return Object.values(data).every(layout => {
                    return (
                        layout &&
                        typeof layout.gridCols === 'number' &&
                        typeof layout.gridRows === 'number' &&
                        Array.isArray(layout.objects) &&
                        layout.objects.every(obj => (
                            typeof obj.row === 'number' &&
                            typeof obj.col === 'number' &&
                            typeof obj.width === 'number' &&
                            typeof obj.height === 'number' &&
                            typeof obj.color === 'string' &&
                            (typeof obj.label === 'string' || obj.label === undefined)
                        ))
                    );
                });
            }
        });


document.addEventListener('DOMContentLoaded', () => {
    // Initialize hero shards calculator
    updateTierOptions('current-star', 'current-tier', true);
    updateTierOptions('target-star', 'target-tier');
    
    document.getElementById('current-star').addEventListener('change', () => updateTierOptions('current-star', 'current-tier', true));
    document.getElementById('target-star').addEventListener('change', () => updateTierOptions('target-star', 'target-tier'));
    document.getElementById('calculate-shards').addEventListener('click', calculateShards);

    // Initialize chief gears calculator
    const gearContainer = document.getElementById("gears-container");
    for (let i = 0; i < 6; i++) {
        gearContainer.appendChild(createGearSelector(i));
    }

    document.getElementById("calculate-all-gears").addEventListener("click", async () => {
    const button = document.getElementById("calculate-all-gears");
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
    
    try {
        // Safely get owned resources with fallback to 0 if input doesn't exist
        const owned = {
            alloy: parseInt(document.getElementById("owned-alloy")?.value || 0),
            solution: parseInt(document.getElementById("owned-solution")?.value || 0),
            design: parseInt(document.getElementById("owned-design")?.value || 0),
            amber: parseInt(document.getElementById("owned-amber")?.value || 0)
        };
        
        let total = {
            alloy: 0,
            solution: 0,
            design: 0,
            amber: 0
        };
        
        let allSteps = [];
        
        document.querySelectorAll(".gear-block").forEach((block, index) => {
            const currentSelect = block.querySelector(".current-level");
            const targetSelect = block.querySelector(".target-level");
            
            if (!currentSelect || !targetSelect) return;
            
            const current = currentSelect.value;
            const target = targetSelect.value;
            
            if (current !== target) {
                const result = calculateGearUpgrade(current, target);
                total.alloy += result.alloy;
                total.solution += result.solution;
                total.design += result.design;
                total.amber += result.amber;
                
                allSteps.push({
                    name: gearNames[index].label,
                    steps: result.steps
                });
            }
        });
        
        displayGearResults(total, owned, allSteps);
        
    } catch (error) {
        console.error("Error in calculation:", error);
        alert("Error in calculation. Please check the console for details.");
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-calculator"></i> Calculate Total Resource Requirements';
    }
});

    // Initialize charms calculator
    const charmsContainer = document.getElementById("charms-container");
    for (let i = 0; i < 6; i++) {
        charmsContainer.appendChild(createCharmsSelector(i));
    }
    document.getElementById("calculate-charms").addEventListener("click", calculateCharms);
});
    </script>
</body>
</html>
